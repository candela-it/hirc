{% extends "base.html"%}

{% block content %}
<div class="ui vertically divided grid">
    <div class="two column row">
        <div class="column">
            <h2>{{ object.title }}</h2>
            <div class="ui segment">
                <p>{{ object.description }}</p>
            </div>
            <p style="font-size: 12px;">created by: <strong>{{ object.created_by }}</strong> <br>
            request status: <strong>{{ object.status }}</strong> <br>
            question set: <strong>{{ object.question_set }}</strong>

            {% if object.request_leader %}
                <br> request leader: {{ object.request_leader }}
            {% endif %}
            </p>
        </div>
        <div class="column">
            <div id="map" style="height: 500px;"></div>
        </div>
    </div>
    <div class="one column row">
        <div class="column">
            {% include "request_qa.html" %}
        </div>
    </div>
    <div class="one column row">
        <div class="column">
            {% include "request_comments.html" %}
        </div>
    </div>
</div>

{% endblock content %}

{% block extra_js %}
    <script type="text/javascript">
        var map = L.map('map').setView([51.505, -0.09], 2);
        var osmUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
        var osmAttrib = 'Map data Â© <a href="http://openstreetmap.org">OpenStreetMap</a> contributors';
        var osmTiles = L.tileLayer(osmUrl, {attribution: osmAttrib});

        map.addLayer(osmTiles);

        var geojsonPolygon = jQuery.parseJSON('{{ object.area_of_interest.geojson|safe }}');

        L.geoJson(geojsonPolygon).addTo(map);


        // add click handler for all future 'red icons'
        $('.ui.answers').on('click', '.answer.save.icon.red.link', function(evt) {
            var link = '/answer/add/'+this.dataset.requestId+'/'+this.dataset.questionId;
            var self = this;

            var input_value = $(this).parent().find('input').val() || '';
            $.ajax(link, {
                method: 'POST',
                data: {'text':input_value,'question':this.dataset.questionId, 'imagery_request':this.dataset.requestId}
            }).done(function () {
                $(self).toggleClass('red').toggleClass('link').toggleClass('disabled');
                //flash message
                var fl_message = $('<div class="ui success message flash"><i class="close icon"></i><div class="header">Answer updated!</div><p></p></div>');
                $('.flash_messages').append(fl_message);
                fl_message.transition('bounce');
                setTimeout(function() {
                        fl_message.transition('fade out', {
                            'complete': function() {fl_message.remove();}
                        });
                }, 5000)
            }).fail(function () {
                //flash message
                var fl_message = $('<div class="ui error message flash"><i class="close icon"></i><div class="header">Error updating answer</div><p>Answer can\'t be empty!</p></div>');
                $('.flash_messages').append(fl_message);
                fl_message.transition('bounce');
                setTimeout(function() {
                        fl_message.transition('fade out', {
                            'complete': function() {fl_message.remove();}
                        });
                }, 5000)
            });
        });

        $('input.answer').on('focusin', function(evt) {
            var save_icon = $(this).parent().find('.answer.save');
            if (save_icon.hasClass('disabled')) {
                save_icon.toggleClass('disabled').toggleClass('red').toggleClass('link');
            }
        });

        // closable messages

    </script>
{% endblock %}